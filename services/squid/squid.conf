# Squid Configuration - SmartCampus Proxy
# Filtrage et caching par rôle utilisateur

# Accès réseau basique
http_port 3128

# Authentification MySQL
auth_param basic program /usr/lib/squid/basic_mysql_auth -l smartcampus -p 3306 -u squid_user -w squid_pass -n users -u username -p password
auth_param basic realm SmartCampus Proxy
auth_param basic credentialsttl 1 hour

# Accès de base
acl all src all
acl localhost src 127.0.0.1/32 [::1]

# Définir les VLANs/réseaux autorisés
acl internal_network src 192.168.99.0/24 192.168.100.0/24 192.168.101.0/24

# Authentification requise
acl authenticated proxy_auth REQUIRED

# Rôles utilisateurs (extraits de commentaires pour demo)
acl students proxy_auth "/etc/squid/groups/students.txt"
acl teachers proxy_auth "/etc/squid/groups/teachers.txt"
acl admins proxy_auth "/etc/squid/groups/admins.txt"
acl guests proxy_auth "/etc/squid/groups/guests.txt"

# Sites bloqués pour étudiants
acl student_blocked_sites dstdomain "/etc/squid/blocked/student_sites.txt"

# Streaming et P2P
acl streaming_services dstdomain "/etc/squid/blocked/streaming.txt"
acl p2p_services dstdomain "/etc/squid/blocked/p2p.txt"

# Domaines autorisés pour invités
acl guest_allowed_sites dstdomain "/etc/squid/blocked/guest_whitelist.txt"

# Protocoles autorisés
acl http proto HTTP
acl https proto HTTPS
acl ftp proto FTP

# Heures de travail
acl work_hours time MTWHF 08:00-18:00

# Caching
cache_dir ufs /var/spool/squid 4096 16 256
cache_replacement_policy heap LFUDA

# Règles d'accès pour les étudiants
http_access allow students !student_blocked_sites !streaming_services !p2p_services work_hours
http_access allow students !student_blocked_sites !streaming_services !p2p_services 20% !work_hours

# Règles d'accès pour les enseignants
http_access allow teachers !streaming_services work_hours
http_access allow teachers 30% !work_hours

# Administrateurs : accès complet
http_access allow admins

# Invités : liste blanche strict
http_access allow guests guest_allowed_sites

# Réseau interne non-auth
http_access allow internal_network localhost

# Refuser tout le reste
http_access deny all

# Logs
access_log /var/log/squid/access.log combined
cache_log /var/log/squid/cache.log
logfile_rotate 10

# Performance
workers 4
dns_nameservers 192.168.99.20

# Timeouts
client_lifetime 1 hour
read_timeout 15 minutes
write_timeout 15 minutes
connect_timeout 5 seconds
