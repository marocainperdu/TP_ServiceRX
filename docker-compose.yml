version: '3.8'

services:
  # ========================================
  # Base de données MariaDB
  # ========================================
  mariadb:
    image: mariadb:10.11
    container_name: campus-mariadb
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: campus_root_2026
      MYSQL_DATABASE: campus_db
      MYSQL_USER: campus_user
      MYSQL_PASSWORD: campus_pass
    volumes:
      - ./data/mariadb:/var/lib/mysql
      - ./configs/mariadb/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - campus-backend
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ========================================
  # DNS Server (Bind9)
  # ========================================
  bind9:
    image: ubuntu/bind9:latest
    container_name: campus-dns
    restart: unless-stopped
    ports:
      - "5353:53/tcp"
      - "5353:53/udp"
    volumes:
      - ./configs/bind9/named.conf:/etc/bind/named.conf:ro
      - ./configs/bind9/zones:/etc/bind/zones:ro
      - ./data/bind9:/var/cache/bind
      - /tmp/bind9-cache:/var/cache/bind/dynamic
    networks:
      campus-network:
        ipv4_address: 10.20.0.10
    environment:
      - TZ=Europe/Paris
    user: "root"
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    healthcheck:
      test: ["CMD", "ps", "aux"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

  # ========================================
  # DHCP Server (ISC DHCP)
  # ========================================
  dhcp:
    image: networkboot/dhcpd:latest
    container_name: campus-dhcp
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./configs/dhcp:/data
      - ./data/dhcp:/var/lib/dhcp
    cap_add:
      - NET_ADMIN
      - NET_RAW
    environment:
      - INTERFACES=eth0
    healthcheck:
      test: ["CMD", "ps", "aux"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ========================================
  # Proxy Cache (Squid)
  # ========================================
  squid:
    image: sameersbn/squid:latest
    container_name: campus-squid
    restart: unless-stopped
    ports:
      - "3128:3128"
    volumes:
      - ./configs/squid/squid.conf:/etc/squid/squid.conf
      - ./data/squid/cache:/var/spool/squid
      - ./data/squid/logs:/var/log/squid
    networks:
      - campus-network

  # ========================================
  # FTP Server (vsftpd)
  # ========================================
  ftp:
    image: fauria/vsftpd:latest
    container_name: campus-ftp
    restart: unless-stopped
    ports:
      - "20:20"
      - "21:21"
      - "21100-21110:21100-21110"
    environment:
      FTP_USER: campus
      FTP_PASS: campus123
      PASV_ADDRESS: 10.20.0.20
      PASV_MIN_PORT: 21100
      PASV_MAX_PORT: 21110
    volumes:
      - ./data/ftp:/home/vsftpd
    networks:
      campus-network:
        ipv4_address: 10.20.0.20

  # ========================================
  # iPXE Boot Server (basé sur Nginx)
  # ========================================
  ipxe:
    image: nginx:alpine
    container_name: campus-ipxe
    restart: unless-stopped
    ports:
      - "69:69/udp"  # TFTP simulé
      - "8080:80"    # HTTP pour fichiers boot
    volumes:
      - ./configs/ipxe:/usr/share/nginx/html
      - ./data/ipxe:/data
    networks:
      campus-network:
        ipv4_address: 10.20.0.15
    environment:
      - TZ=Europe/Paris

  # ========================================
  # Reverse Proxy (Nginx)
  # ========================================
  nginx:
    image: nginx:alpine
    container_name: campus-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./configs/nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./configs/nginx/conf.d:/etc/nginx/conf.d
      - ./web:/usr/share/nginx/html/static
    depends_on:
      - ipxe
    networks:
      campus-network:
        ipv4_address: 10.20.0.30

  # ========================================
  # Page d'accueil du campus
  # ========================================
  campus-portal:
    image: nginx:alpine
    container_name: campus-portal
    restart: unless-stopped
    volumes:
      - ./web:/usr/share/nginx/html:ro
    networks:
      - campus-network

# ========================================
# Réseaux Docker
# ========================================
networks:
  campus-network:
    driver: bridge
    ipam:
      config:
        - subnet: 10.20.0.0/16
          gateway: 10.20.0.1
  campus-backend:
    driver: bridge
    internal: true

volumes:
  mariadb_data:
  nextcloud_data:
  moodle_data:
  bind9_data:
